# This workflow does the following:
# - Downloads https://www.gov.uk/bank-holidays.json
# - Rewrites the dictionary keys to be human-readable names of countries
# - Creates a new JSON object that BigQuery's automatic schema detection will
#   understand.
# - Saves the JSON object to a bucket
# - Loads the JSON into BigQuery
# - Extracts data from the JSON
# In terraform you need to escape the $$ or it will cause errors.
main:
    steps:
    - getBankHolidaysObject:
        call: http.get
        args:
            url: https://www.gov.uk/bank-holidays.json
        result: bankHolidaysObject
    - renameDivisions:
        assign:
        - bankHolidaysObject["body"]["england-and-wales"]["division"]: "England and Wales"
        - bankHolidaysObject["body"]["northern-ireland"]["division"]: "Northern Ireland"
        - bankHolidaysObject["body"]["scotland"]["division"]: "Scotland"
    - renameKeys:
        assign:
        - finalJsonObject:
            - body:
                - '$${bankHolidaysObject["body"]["england-and-wales"]}'
                - '$${bankHolidaysObject["body"]["northern-ireland"]}'
                - '$${bankHolidaysObject["body"]["scotland"]}'
    - writeBankHolidaysFile:
        call: googleapis.storage.v1.objects.insert
        args:
            bucket: ${processed_bucket}
            name: 'bank-holidays/bank-holidays.json'
            body: $${finalJsonObject[0]}
    - uploadToBigQuery:
        call: googleapis.bigquery.v2.jobs.query
        args:
            projectId: ${project_id}
            body:
                useLegacySql: false
                query: ${load_raw_query}
        result: queryResult
    - composeQuery:
        assign:
          - query: ${load_occurence_query}
    - extractFromJson:
        call: googleapis.bigquery.v2.jobs.query
        args:
            projectId: ${project_id}
            body:
                useLegacySql: false
                query: $${query}
        result: queryResult
    - deriveBankHolidayUrlTable:
        call: googleapis.bigquery.v2.jobs.query
        args:
            projectId: ${project_id}
            body:
                useLegacySql: false
                query: ${load_url_query}
        result: queryResult
    - deriveBankHolidayTitleTable:
        call: googleapis.bigquery.v2.jobs.query
        args:
            projectId: ${project_id}
            body:
                useLegacySql: false
                query: $${
                    "TRUNCATE TABLE content.bank_holiday_title; " +
                    "INSERT INTO content.bank_holiday_title " +
                    "SELECT DISTINCT " +
                    "  'https://www.gov.uk/' || REPLACE(REPLACE(TO_BASE64(SHA256(events.title)), '+', '-'), '/', '_') AS url, " +
                    "  events.title " +
                    "FROM content.bank_holiday_raw, " +
                    "  UNNEST(body) AS body, " +
                    "  UNNEST(events) AS events " +
                    "; "
                }
        result: queryResult